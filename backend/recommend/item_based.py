import pandas as pd
import numpy as np
from pathlib import Path
from scipy.sparse import csr_matrix
from collections import defaultdict, Counter
from functools import lru_cache



# ----------------------------------------------------------
# 0. ë°ì´í„° ë¡œë“œ
# ----------------------------------------------------------
BASE_DIR = Path(__file__).resolve().parent.parent
DATA_PATH = BASE_DIR / "processed" / "joined_filtered_6cols.csv"

df = pd.read_csv(DATA_PATH)
print(f"ğŸš€ ë°ì´í„° ë¡œë“œ ì™„ë£Œ. shape={df.shape}")



# ----------------------------------------------------------
# 1. ì „ì—­ êµ¬ì¡° ì´ˆê¸°í™”
# ----------------------------------------------------------

USER_IDS = df["user_id"].unique()
GAME_TITLES = df["title"].unique()

USER2IDX = {u: i for i, u in enumerate(USER_IDS)}
GAME2IDX = {g: i for i, g in enumerate(GAME_TITLES)}
IDX2GAME = {i: t for t, i in GAME2IDX.items()}

values = df["is_recommended"].values
rows = df["user_id"].map(USER2IDX).values
cols = df["title"].map(GAME2IDX).values

R = csr_matrix((values, (rows, cols)),
               shape=(len(USER_IDS), len(GAME_TITLES)))

N_USERS, N_GAMES = R.shape

# Item â†’ Users mapping (ê²Œì„ ê¸°ì¤€ìœ¼ë¡œ, í•´ë‹¹ ê²Œì„ì„ ì¶”ì²œí•œ ìœ ì €ë“¤ì˜ ì¸ë±ìŠ¤ ëª©ë¡)
R_T = R.T.tocsr()
ITEM_USERS = [np.sort(R_T[i].indices) for i in range(N_GAMES)]

# ê° ê²Œì„ë³„ ì¶”ì²œí•œ ìœ ì € ìˆ˜ ë° ê·¸ ì œê³±ê·¼ (ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ë¶„ëª¨ì— ì‚¬ìš©)
ITEM_USER_LEN = np.array([len(u) for u in ITEM_USERS])
SQRT_ITEM_USER_LEN = np.sqrt(ITEM_USER_LEN)


# ----------------------------------------------------------
# 2. í•˜ì´í¼íŒŒë¼ë¯¸í„°
# ----------------------------------------------------------
BETA = 10            # Discountì— ì‚¬ìš©: êµì§‘í•© í¬ê¸°ê°€ BETA ì´ìƒì´ë©´ íŒ¨ë„í‹° 1, ë¯¸ë§Œì´ë©´ inter_cnt / BETA ë§Œí¼ ê°ì†Œ
MIN_INTERSECTION = 2 # ë‘ ê²Œì„ì„ í•¨ê»˜ ì¶”ì²œí•œ ìœ ì €ê°€ 2ëª… ë¯¸ë§Œì´ë©´ ìœ ì‚¬ë„ 0ìœ¼ë¡œ ì²˜ë¦¬ (ë…¸ì´ì¦ˆ ì œê±°ìš©)
MAX_CANDIDATES = 200 # í›„ë³´ ì•„ì´í…œì„ Co-occurrenceë¡œ ë½‘ì„ ë•Œ ìƒìœ„ 200ê°œê¹Œì§€ë§Œ ì‚¬ìš© (ì†ë„/ë©”ëª¨ë¦¬ ì ˆì•½)



# ----------------------------------------------------------
# 3. ì´ˆê³ ì† two-pointer êµì§‘í•©
# ----------------------------------------------------------
def fast_intersection_size(a, b):
    i = j = cnt = 0
    la, lb = len(a), len(b)

    # a, bëŠ” ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ëœ "ìœ ì € ì¸ë±ìŠ¤ ë°°ì—´"
    # ë‘ ë°°ì—´ì˜ êµì§‘í•© í¬ê¸°ë¥¼ O(len(a) + len(b)) ì— êµ¬í•˜ëŠ” íˆ¬ í¬ì¸í„° ì•Œê³ ë¦¬ì¦˜
    while i < la and j < lb:
        if a[i] == b[j]:
            # ê°™ì€ ìœ ì € ì¸ë±ìŠ¤ â†’ êµì§‘í•© 1 ì¦ê°€
            cnt += 1
            i += 1
            j += 1
        elif a[i] < b[j]:
            # a[i]ê°€ ë” ì‘ìœ¼ë©´ a ìª½ í¬ì¸í„°ë¥¼ í•œ ì¹¸ ì´ë™
            i += 1
        else:
            # b[j]ê°€ ë” ì‘ìœ¼ë©´ b ìª½ í¬ì¸í„°ë¥¼ í•œ ì¹¸ ì´ë™
            j += 1

    return cnt



# ----------------------------------------------------------
# 4. ë¬¸ì„œ ê¸°ë°˜ item-item similarity + LRU Cache
# ----------------------------------------------------------
@lru_cache(maxsize=300_000)
def item_similarity(i_idx, j_idx):
    """
    ë‘ ê²Œì„ i, j ì‚¬ì´ì˜ "ì•„ì´í…œ ê¸°ë°˜ ìœ ì‚¬ë„"ë¥¼ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜.

    - ì…ë ¥:
        i_idx: ê²Œì„ iì˜ ë‚´ë¶€ ì¸ë±ìŠ¤ (0 ~ N_GAMES-1)
        j_idx: ê²Œì„ jì˜ ë‚´ë¶€ ì¸ë±ìŠ¤ (0 ~ N_GAMES-1)

    - ë‚´ë¶€ ë¡œì§:
        1) ê° ê²Œì„ì„ ì¶”ì²œí•œ ìœ ì € ì§‘í•© U_i, U_jë¥¼ ê°€ì ¸ì˜¨ë‹¤.
        2) U_i âˆ© U_j (ë‘ ê²Œì„ì„ ëª¨ë‘ ì¶”ì²œí•œ ìœ ì € ìˆ˜)ë¥¼ êµ¬í•œë‹¤.
        3) êµì§‘í•© í¬ê¸°ê°€ ë„ˆë¬´ ì‘ìœ¼ë©´(ì‹ ë¢°ë„ ë‚®ìŒ) ìœ ì‚¬ë„ë¥¼ 0ìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤.
        4) ì½”ì‚¬ì¸ ìœ ì‚¬ë„: |U_i âˆ© U_j| / (sqrt(|U_i|) * sqrt(|U_j|)) ê³„ì‚°
        5) Discount factor: min(|U_i âˆ© U_j| / BETA, 1.0)ì„ ê³±í•´,
           ê³µí†µ ìœ ì € ìˆ˜ê°€ ì ìœ¼ë©´ ìœ ì‚¬ë„ë¥¼ ì¤„ì´ëŠ” íš¨ê³¼ë¥¼ ì¤€ë‹¤.
        6) LRU ìºì‹œë¥¼ ì‚¬ìš©í•˜ì—¬ (i_idx, j_idx) ì¡°í•©ì— ëŒ€í•´ í•œ ë²ˆ ê³„ì‚°ëœ ìœ ì‚¬ë„ëŠ”
           ë©”ëª¨ë¦¬ì— ì €ì¥í•´ ë‘ê³ , ì´í›„ ì¬ì‚¬ìš©í•  ë•ŒëŠ” ê³„ì‚° ì—†ì´ ë°”ë¡œ ë°˜í™˜í•œë‹¤.

    - ì¶œë ¥:
        float ìœ ì‚¬ë„ ê°’ (0.0 ì´ìƒ, ì½”ì‚¬ì¸ * discount)
    """

    # ë‘ ê²Œì„ì„ ì¢‹ì•„í•œ ìœ ì € ëª©ë¡ (ì •ë ¬ëœ ìœ ì € ì¸ë±ìŠ¤ ë°°ì—´)
    users_i = ITEM_USERS[i_idx]  # ê²Œì„ ië¥¼ ì¶”ì²œí•œ ìœ ì €ë“¤ì˜ ì¸ë±ìŠ¤ ë¦¬ìŠ¤íŠ¸
    users_j = ITEM_USERS[j_idx]  # ê²Œì„ jë¥¼ ì¶”ì²œí•œ ìœ ì €ë“¤ì˜ ì¸ë±ìŠ¤ ë¦¬ìŠ¤íŠ¸

    # 1) êµì§‘í•© í¬ê¸° = ë‘ ê²Œì„ì„ ëª¨ë‘ ì¶”ì²œí•œ ìœ ì € ìˆ˜ = |U_i âˆ© U_j|
    inter_cnt = fast_intersection_size(users_i, users_j)

    # 2) êµì§‘í•©ì´ ë„ˆë¬´ ì‘ìœ¼ë©´ (ì˜ˆ: 0ëª… ë˜ëŠ” 1ëª…) â†’ ìš°ì—°ì¼ ìˆ˜ ìˆë‹¤ê³  ë³´ê³  ìœ ì‚¬ë„ 0 ì²˜ë¦¬
    #    MIN_INTERSECTION=2 ì´ë¯€ë¡œ, ìµœì†Œ 2ëª… ì´ìƒì´ ë‘ ê²Œì„ì„ ëª¨ë‘ ì¶”ì²œí•´ì•¼ ìœ ì‚¬ë„ë¥¼ ì¸ì •.
    if inter_cnt < MIN_INTERSECTION:
        return 0.0

    # 3) ì½”ì‚¬ì¸ ìœ ì‚¬ë„ì˜ ë¶„ëª¨: sqrt(|U_i|) * sqrt(|U_j|)
    #    ITEM_USER_LEN[i_idx] = |U_i|, SQRT_ITEM_USER_LEN[i_idx] = sqrt(|U_i|)
    denom = SQRT_ITEM_USER_LEN[i_idx] * SQRT_ITEM_USER_LEN[j_idx]
    if denom == 0:
        # ì–´ë–¤ ê²Œì„ì´ í•œ ë²ˆë„ ì¶”ì²œë˜ì§€ ì•Šì•˜ë‹¤ë©´ (ì¶”ì²œ ìœ ì € ìˆ˜ê°€ 0)
        # ë¶„ëª¨ê°€ 0 â†’ ìœ ì‚¬ë„ ì •ì˜ ë¶ˆê°€ â†’ 0.0 ë°˜í™˜
        return 0.0

    # 4) ê¸°ë³¸ ì½”ì‚¬ì¸ ìœ ì‚¬ë„:
    #    Sim_cos(i,j) = |U_i âˆ© U_j| / (sqrt(|U_i|) * sqrt(|U_j|))
    sim = inter_cnt / denom

    # 5) Discount factor ì ìš©:
    #    DiscountedSim(i,j) = Sim_cos(i,j) * min(|U_i âˆ© U_j| / BETA, 1.0)
    #    - êµì§‘í•© ìœ ì € ìˆ˜ê°€ BETA ë¯¸ë§Œì´ë©´ ë¹„ìœ¨ë§Œí¼ ê³±í•´ì„œ ìœ ì‚¬ë„ë¥¼ ì¤„ì„
    #    - BETA ì´ìƒì´ë©´ 1.0ì„ ê³±í•˜ë¯€ë¡œ ë” ì´ìƒ ê¹ì§€ ì•ŠìŒ
    sim *= min(inter_cnt / BETA, 1.0)

    # ìµœì¢… ìœ ì‚¬ë„ ë°˜í™˜
    return sim



# ----------------------------------------------------------
# 5. ì˜ˆì¸¡ê°’ ê³„ì‚° (ë¬¸ì„œ ì •ì„ì—ì„œ "ì •ê·œí™”"ë§Œ ì œê±°í•œ ë²„ì „)
# ----------------------------------------------------------
def predict_score(user_idx, target_item_idx):
    """
    íŠ¹ì • ìœ ì €(user_idx)ê°€ ì•„ì§ í”Œë ˆì´/ì¶”ì²œí•˜ì§€ ì•Šì€ ê²Œì„(target_item_idx)ì— ëŒ€í•´
    "ì–¼ë§ˆë‚˜ ì¢‹ì•„í•  ê²ƒ ê°™ì€ì§€"ë¥¼ ì ìˆ˜ë¡œ ì˜ˆì¸¡í•˜ëŠ” í•¨ìˆ˜.

    ì•„ì´í…œ ê¸°ë°˜ í˜‘ì—… í•„í„°ë§ì˜ ì•„ì´ë””ì–´:
    - "ìœ ì €ê°€ ê³¼ê±°ì— ì¢‹ì•„í–ˆë˜ ê²Œì„ë“¤"ê³¼
    - "ì§€ê¸ˆ ì ìˆ˜ë¥¼ ë§¤ê¸°ë ¤ëŠ” íƒ€ê²Ÿ ê²Œì„" ì‚¬ì´ì˜ ìœ ì‚¬ë„(DiscountedSim)ë¥¼ ì´ìš©í•œë‹¤.

    ì—¬ê¸°ì„œëŠ” r_(a,q) âˆˆ {0,1}(ì¶”ì²œ ì—¬ë¶€) ì´ê³ ,
    ë¶„ëª¨ì˜ sum(|Sim|)ë¡œ ë‚˜ëˆ„ëŠ” ì •ê·œí™”ë¥¼ ì œê±°í•˜ê³ 
    ë‹¨ìˆœíˆ "ìœ ì‚¬ë„ì˜ í•©"ì„ ì ìˆ˜ë¡œ ì‚¬ìš©í•œë‹¤.

    ì§ê´€:
    - ìœ ì €ê°€ ì¢‹ì•„í–ˆë˜ ê²Œì„ë“¤ ì¤‘ì—ì„œ
      íƒ€ê²Ÿ ê²Œì„ê³¼ "ë¹„ìŠ·í•œ ê²Œì„"ì´ ë§ì„ìˆ˜ë¡ ì ìˆ˜ëŠ” ì»¤ì§„ë‹¤.
    - ê° ë¹„ìŠ·í•œ ê²Œì„ì˜ ìœ ì‚¬ë„ê°€ í´ìˆ˜ë¡ ì ìˆ˜ëŠ” ë” ì»¤ì§„ë‹¤.

    ìˆ˜ì‹ í˜•íƒœ:
    - I_a: ìœ ì € aê°€ ì¶”ì²œí–ˆë˜ ê²Œì„ë“¤ì˜ ì§‘í•©
    - DiscountedSim(p, q): item_similarityì—ì„œ ê³„ì‚°í•œ ìœ ì‚¬ë„
    - ì˜ˆì¸¡ ì ìˆ˜:
        r_hat(a, p) = sum_{q âˆˆ I_a} DiscountedSim(p, q)
    """

    # 1) í•´ë‹¹ ìœ ì €ê°€ ì¶”ì²œí•œ(ì¢‹ì•„í•œ) ê²Œì„ë“¤ì˜ ì¸ë±ìŠ¤ ëª©ë¡
    #    R[user_idx]ëŠ” "ê·¸ ìœ ì €ì˜ í–‰"ì´ê³ , .indicesëŠ” ê°’ì´ 0ì´ ì•„ë‹Œ ì—´ ì¸ë±ìŠ¤(=is_recommended=1ì¸ ê²Œì„)
    rated_items = R[user_idx].indices
    if len(rated_items) == 0:
        # ì´ ìœ ì €ê°€ ì•„ì§ ì•„ë¬´ ê²Œì„ë„ ì¶”ì²œí•˜ì§€ ì•Šì•˜ë‹¤ë©´
        # ì´ì›ƒ ê¸°ë°˜ CFë¡œëŠ” ì˜ˆì¸¡ ë¶ˆê°€ â†’ 0.0 ë°˜í™˜ (í˜¹ì€ ì½œë“œìŠ¤íƒ€íŠ¸ ì²˜ë¦¬ë¥¼ ë”°ë¡œ í•´ì•¼ í•¨)
        return 0.0

    # 2) ì ìˆ˜ ëˆ„ì  ë³€ìˆ˜
    score = 0.0

    # 3) ìœ ì €ê°€ ì¢‹ì•„í–ˆë˜ ê° ê²Œì„ qì— ëŒ€í•´,
    #    íƒ€ê²Ÿ ê²Œì„(target_item_idx)ê³¼ì˜ ìœ ì‚¬ë„ simì„ ê³„ì‚°í•˜ê³  ëª¨ë‘ í•©ì‚°
    for q in rated_items:
        # item_similarity(target, q) = DiscountedSim(target, q)
        sim = item_similarity(target_item_idx, q)

        # ìœ ì‚¬ë„ê°€ 0 ì´í•˜ì´ë©´(0 í¬í•¨) ê¸°ì—¬ë„ê°€ ì—†ìœ¼ë¯€ë¡œ ê±´ë„ˆë›´ë‹¤.
        # - 0ì¸ ê²½ìš°: êµì§‘í•©ì´ ì‘ê±°ë‚˜, ì•„ì˜ˆ ì—†ê±°ë‚˜, ë¶„ëª¨=0 ë“±ìœ¼ë¡œ íŒë‹¨ëœ "ë¹„ìŠ·í•˜ì§€ ì•Šì€ ê²Œì„"
        # - ìŒìˆ˜ simì€ ì—¬ê¸°ì„œëŠ” ë‚˜ì˜¤ì§€ ì•Šì§€ë§Œ, ì•ˆì „í•˜ê²Œ <= 0ì¼ ë•Œ skip
        if sim <= 0:
            continue

        # r_(a,q) = 1 (í•´ë‹¹ ìœ ì €ê°€ që¥¼ ì¶”ì²œí•œ ê²Œì„ë§Œ qì— í¬í•¨ë˜ë¯€ë¡œ)
        # â†’ ê°€ì¤‘í•© sum(sim * r)ì—ì„œ r=1 ì´ë¼ simë§Œ ë”í•˜ë©´ ë¨
        score += sim

    # 4) ìµœì¢… ì ìˆ˜ ë°˜í™˜
    #    - ì ˆëŒ€ê°’ì€ ì¤‘ìš”í•˜ì§€ ì•Šê³ , "ë‹¤ë¥¸ ê²Œì„ë“¤ê³¼ì˜ ìƒëŒ€ì  í¬ê¸°"ê°€ ì¤‘ìš”
    #    - ì´ ê°’ì´ í° ê²Œì„ì¼ìˆ˜ë¡ ìœ ì €ì˜ ì·¨í–¥ê³¼ ë” ì˜ ë§ì„ ê²ƒìœ¼ë¡œ ì˜ˆì¸¡
    return score



# ----------------------------------------------------------
# 6. ì¶”ì²œ í•¨ìˆ˜ (ì •ì„ + í›„ë³´ Pruning ìµœì í™”)
# ----------------------------------------------------------
def recommend_by_item(user_id: int):
    """
    ì£¼ì–´ì§„ user_idì— ëŒ€í•´ "ì•„ì´í…œ ê¸°ë°˜ í˜‘ì—… í•„í„°ë§"ìœ¼ë¡œ
    ì¶”ì²œ ê²Œì„ Top-N (ì—¬ê¸°ì„œëŠ” 5ê°œ)ì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜.

    ì „ì²´ íë¦„:
    1) user_idë¥¼ ë‚´ë¶€ ì¸ë±ìŠ¤ë¡œ ë³€í™˜
    2) í•´ë‹¹ ìœ ì €ê°€ ê³¼ê±°ì— ì¶”ì²œí–ˆë˜ ê²Œì„ ëª©ë¡ì„ ê°€ì ¸ì˜´
    3) ê·¸ ê²Œì„ë“¤ì„ ê°™ì´ ì¶”ì²œí–ˆë˜ ë‹¤ë¥¸ ìœ ì €ë“¤ì´ ë˜ ì–´ë–¤ ê²Œì„ë“¤ì„ ì¶”ì²œí–ˆëŠ”ì§€ ê¸°ë°˜ìœ¼ë¡œ
       "í›„ë³´ ê²Œì„"ì„ Co-occurrence í˜•íƒœë¡œ ìˆ˜ì§‘
    4) ê° í›„ë³´ ê²Œì„ì— ëŒ€í•´ predict_score(ìœ ì‚¬ë„ í•©)ë¥¼ ê³„ì‚°
    5) ì ìˆ˜ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ í›„ ìƒìœ„ 5ê°œë¥¼ ì¶”ì²œ ë¦¬ìŠ¤íŠ¸ë¡œ ë°˜í™˜
    """

    # 1) ì¡´ì¬í•˜ì§€ ì•ŠëŠ” user_idì— ëŒ€í•œ ë°©ì–´ ë¡œì§
    if user_id not in USER2IDX:
        return {
            "type": "item_based_paper",
            "input_user_id": user_id,
            "result": [],
            "message": "ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        }

    # 2) user_id â†’ ë‚´ë¶€ ìœ ì € ì¸ë±ìŠ¤(u_idx) ë³€í™˜
    u_idx = USER2IDX[user_id]

    # ì´ ìœ ì €ê°€ ì¶”ì²œí•œ ê²Œì„ë“¤ì˜ ì¸ë±ìŠ¤ ëª©ë¡
    rated_items = R[u_idx].indices
    # ì§‘í•©ìœ¼ë¡œë„ ë§Œë“¤ì–´ë‘ë©´ "ì´ë¯¸ ë³¸ ê²Œì„"ì„ O(1)ì— ì œì™¸í•  ìˆ˜ ìˆìŒ
    rated_set = set(rated_items)

    # 3) ì´ ìœ ì €ê°€ ì•„ì§ ì•„ë¬´ ê²Œì„ë„ ì¶”ì²œí•˜ì§€ ì•Šì•˜ë‹¤ë©´
    #    ì•„ì´í…œ ê¸°ë°˜ CF(ì´ì›ƒ ê¸°ë°˜)ë¡œëŠ” ì¶”ì²œ ë¶ˆê°€ â†’ ì•ˆë‚´ ë©”ì‹œì§€
    if len(rated_items) == 0:
        return {
            "type": "item_based_paper",
            "input_user_id": user_id,
            "result": [],
            "message": "ì‚¬ìš©ìê°€ ì¶”ì²œí•œ ê²Œì„ì´ ì—†ìŠµë‹ˆë‹¤."
        }

    # ------ í›„ë³´ ì•„ì´í…œ ìˆ˜ì§‘ (Co-occurrence ê¸°ë°˜) ------
    # common_counter[g] = "ìœ ì €ê°€ ì¢‹ì•„í–ˆë˜ ê²Œì„ë“¤ê³¼ í•¨ê»˜ ì¶”ì²œëœ ê²Œì„ gì˜ ë“±ì¥ íšŸìˆ˜"
    common_counter = Counter()

    # ì‚¬ìš©ìê°€ ì¢‹ì•„í–ˆë˜ ê° ê²Œì„ item ì— ëŒ€í•´
    for item in rated_items:
        # ê·¸ ê²Œì„ì„ ì¶”ì²œí•œ ëª¨ë“  ìœ ì € uì— ëŒ€í•´
        for u in ITEM_USERS[item]:
            # ê·¸ ìœ ì € uê°€ ì¶”ì²œí•œ ëª¨ë“  ê²Œì„ë“¤ì„ ì¹´ìš´íŠ¸ ì¦ê°€
            # R[u].indices = "ìœ ì € uê°€ ì¶”ì²œí•œ ê²Œì„ë“¤ì˜ ì¸ë±ìŠ¤"
            common_counter.update(R[u].indices)

    # common_counter.most_common(MAX_CANDIDATES)ëŠ”
    # "ë‚´ê°€ ì¢‹ì•„í–ˆë˜ ê²Œì„ë“¤ê³¼ ìì£¼ ê°™ì´ ì¶”ì²œë˜ì—ˆë˜ ê²Œì„" ìƒìœ„ 200ê°œë¥¼ ì˜ë¯¸.
    # ì´ ì¤‘ì—ì„œ ì´ë¯¸ ë‚´ê°€ ì¶”ì²œí•œ ê²Œì„(rated_setì— í¬í•¨ëœ ê²ƒ)ì€ ì œì™¸í•œë‹¤.
    candidate_items = [
        g for g, _ in common_counter.most_common(MAX_CANDIDATES)
        if g not in rated_set
    ]

    # ------ ì˜ˆì¸¡ê°’ ê³„ì‚° ------
    predictions = []

    # ê° í›„ë³´ ê²Œì„ì— ëŒ€í•´
    for item in candidate_items:
        # ì´ ìœ ì €(u_idx)ê°€ ê·¸ ê²Œì„(item)ì„ ì–¼ë§ˆë‚˜ ì¢‹ì•„í• ì§€ ì ìˆ˜ ì˜ˆì¸¡
        score = predict_score(u_idx, item)
        if score > 0:
            # (ê²Œì„ ì¸ë±ìŠ¤, ì˜ˆì¸¡ ì ìˆ˜) íŠœí”Œë¡œ ì €ì¥
            predictions.append((item, score))

    # ë§Œì•½ ëª¨ë“  í›„ë³´ì— ëŒ€í•´ ì ìˆ˜ê°€ 0 ì´í•˜ë¼ì„œ predictionsê°€ ë¹„ì–´ ìˆìœ¼ë©´
    # â†’ ì¶”ì²œì„ ìƒì„±í•  ìˆ˜ ì—†ë‹¤ê³  ì•ˆë‚´
    if not predictions:
        return {
            "type": "item_based_paper",
            "input_user_id": user_id,
            "result": [],
            "message": "ì¶”ì²œ ê²°ê³¼ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        }

    # ì˜ˆì¸¡ ì ìˆ˜ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ í›„ ìƒìœ„ 5ê°œë§Œ ì‚¬ìš©
    predictions = sorted(predictions, key=lambda x: x[1], reverse=True)[:5]

    # ìµœì¢…ì ìœ¼ë¡œ:
    # - title: ê²Œì„ ì œëª© (IDX2GAMEìœ¼ë¡œ ì¸ë±ìŠ¤ë¥¼ ë‹¤ì‹œ ì œëª©ìœ¼ë¡œ ë³µì›)
    # - sim: ì˜ˆì¸¡ ì ìˆ˜ (ì—¬ê¸°ì„œëŠ” "ìœ ì‚¬ë„ í•©")ë¥¼ ì†Œìˆ˜ 5ìë¦¬ê¹Œì§€ ë°˜ì˜¬ë¦¼
    return {
        "type": "item_based_paper",
        "input_user_id": user_id,
        "result": [
            {"title": IDX2GAME[i], "sim": round(float(s), 5)}
            for i, s in predictions
        ]
    }
